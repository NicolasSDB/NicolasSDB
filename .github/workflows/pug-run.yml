name: Generate Pug Runner

on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:
  generate:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Generate snake.svg
        uses: Platane/snk/svg-only@v3
        with:
          github_user_name: ${{ github.repository_owner }}
          outputs: dist/snake.svg?palette=github-dark

      - name: Build pug-run.svg (embed snake + sprite animation)
        run: |
          node <<'NODE'
          const fs = require("fs");

          // Lê o snake e mantém só o conteúdo interno (sem <svg> externo)
          const snakeInner = fs.readFileSync("dist/snake.svg", "utf8")
            .replace(/<\?xml[^>]*\?>\s*/g, "")
            .replace(/^\s*<svg[^>]*>/i, "")
            .replace(/<\/svg>\s*$/i, "");

          const W = 900;
          const H = 200;

          // Seus frames (do repo profile-assets)
          const frames = [
            "https://raw.githubusercontent.com/NicolasSDB/profile-assets/main/2.png",
            "https://raw.githubusercontent.com/NicolasSDB/profile-assets/main/3.png",
            "https://raw.githubusercontent.com/NicolasSDB/profile-assets/main/4.png",
            "https://raw.githubusercontent.com/NicolasSDB/profile-assets/main/5.png",
          ];

          // troca de frame (sprite)
          const frameValues = frames.join(";") + ";" + frames[0];

          const svg = `
          <svg xmlns="http://www.w3.org/2000/svg"
               xmlns:xlink="http://www.w3.org/1999/xlink"
               width="${W}" height="${H}" viewBox="0 0 ${W} ${H}">

            <!-- snake embutido (fundo) -->
            <g>${snakeInner}</g>

            <!-- pug sprite -->
            <image id="pug" href="${frames[0]}" xlink:href="${frames[0]}" width="42" height="42">

              <!-- animação do sprite (perninhas) -->
              <animate attributeName="href" dur="0.33s" repeatCount="indefinite"
                       calcMode="discrete" values="${frameValues}" />
              <animate attributeName="xlink:href" dur="0.33s" repeatCount="indefinite"
                       calcMode="discrete" values="${frameValues}" />

              <!-- movimento (vai e volta) -->
              <animateMotion dur="10s" repeatCount="indefinite"
                             keyTimes="0;0.5;1"
                             calcMode="linear"
                             path="M 20 125 L 860 125 L 20 125" />
            </image>
          </svg>
          `.trim();

          fs.writeFileSync("dist/pug-run.svg", svg, "utf8");
          console.log("OK: dist/pug-run.svg gerado com sprite + movimento.");
          NODE

      - name: Publish to output branch
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: output
          build_dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
